<!--
x-html.html v0.0.20140221
(c) 2013 Joachim Wester
MIT license
https://github.com/PuppetJs/x-html
-->
<link rel="import" href="../polymer/polymer.html">
<style>
x-html[currentnode]{
  display: none;
}
</style>
<script>
  (function () {
    var XHTMLPrototype = Object.create( (HTMLTemplateElement || HTMLElement ).prototype);

    XHTMLPrototype.loadTemplate_ = function() {
      var val = this.getAttribute('content');
      if (val && (val.indexOf('/') === 0 || val.indexOf('./') === 0)) {
        //val is a URL, load the partial from the HTTP server/cache
        var oReq = new XMLHttpRequest();
        var that = this;
        oReq.onload = function (event) {
          that.reattachTemplate_(event.target.responseText);
        };
        oReq.open("GET", val, true);
        oReq.send();
      }
      else {
        //val is HTML code, insert the partial from the string
        this.reattachTemplate_(val);
      }
    };

    XHTMLPrototype.reattachTemplate_ = function(html) {
      var template = this.template;
      if( this.template ){
        this.clear();
      }else{
        this.template = document.createElement("template");
      }
      this.template.setAttribute("bind","");
      debugger;
      this.template.innerHTML = html;
      if( this.getAttribute('currentnode') || this.getAttribute('currentnode')==="" ){
        this.parentNode.insertBefore(this.template, this.nextSibling);
      } else {
        this.appendChild( this.template );// = '<template bind>' + html + '</template>';
      }

      if(window.PolymerExpressions) {
        this.template.bindingDelegate = new PolymerExpressions; //use PolymerExpressions if available. This allows <template if="{{val == 1}}">, etc
      }

      if( !this.model && this.bindings ){
        //`content` is in DOM and `value` is in Shadow DOM
        this.model  = (this.bindings.content || this.bindings.value).object_;
      }
      this.template.model = this.model;

    };

    /**
     * Empty xhml content.
     * @TODO clear also siblings for `x-html[currentnode]`
     * @requires HTMLTemplateElement#clear (https://github.com/Polymer/TemplateBinding/blob/51df59c16e0922dec041cfe604016aac00918d5d/src/TemplateBinding.js#L595)
     * @return {x-html element} self
     */
    XHTMLPrototype.clear = function(){
      return this.template.clear();
    }


    XHTMLPrototype.attachedCallback = function () {
      var that = this;
      this.loadTemplate_();

      var observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === "attributes" && mutation.attributeName === "content") {
            that.loadTemplate_();
          }
        });
      });
      observer.observe(this, {
        attributes: true
      });
    };

    document.register('x-html', {
      prototype: XHTMLPrototype
    });
  })();
</script>